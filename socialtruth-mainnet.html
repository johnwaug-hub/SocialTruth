<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTruth DAO - Cardano Mainnet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/lucid-cardano@0.10.7/web/mod.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tier-bronze {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }
        
        .tier-silver {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
        }
        
        .tier-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .tier-platinum {
            background: linear-gradient(135deg, #E5E4E2 0%, #B4B4B4 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
        }
        
        .modal.active {
            display: flex;
        }
        
        .vote-true {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .vote-false {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center text-white font-bold">
                        ST
                    </div>
                    <span class="text-xl font-bold text-gray-900">SocialTruth DAO</span>
                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">Mainnet</span>
                </div>
                
                <div class="hidden md:flex items-center gap-6">
                    <a href="#home" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
                    <a href="#news" class="text-gray-700 hover:text-blue-600 font-medium">News Feed</a>
                    <a href="#leaderboard" class="text-gray-700 hover:text-blue-600 font-medium">Leaderboard</a>
                    <a href="#about" class="text-gray-700 hover:text-blue-600 font-medium">About</a>
                </div>
                
                <div id="walletSection">
                    <button onclick="connectWallet()" id="connectBtn" class="gradient-bg text-white px-6 py-2 rounded-lg font-medium hover:opacity-90 transition">
                        Connect Wallet
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="gradient-bg text-white py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6 fade-in">
                Verified Reality.<br/>Earned Reputation.
            </h1>
            <p class="text-xl text-blue-100 mb-8 max-w-2xl mx-auto fade-in">
                A decentralized platform for truth verification powered by community voting and Cardano blockchain.
            </p>
            <div class="flex gap-4 justify-center fade-in">
                <button onclick="scrollToNews()" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-blue-50 transition">
                    Browse News
                </button>
                <button onclick="openSubmitModal()" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition">
                    Submit News
                </button>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="py-12 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                <div>
                    <div class="text-4xl font-bold text-blue-600" id="totalNews">156</div>
                    <div class="text-gray-600 mt-2">News Submitted</div>
                </div>
                <div>
                    <div class="text-4xl font-bold text-purple-600" id="totalVotes">2,847</div>
                    <div class="text-gray-600 mt-2">Total Votes</div>
                </div>
                <div>
                    <div class="text-4xl font-bold text-green-600" id="activeUsers">432</div>
                    <div class="text-gray-600 mt-2">Active Users</div>
                </div>
                <div>
                    <div class="text-4xl font-bold text-orange-600">10M</div>
                    <div class="text-gray-600 mt-2">TRUTH Supply</div>
                </div>
            </div>
        </div>
    </section>

    <!-- News Feed Section -->
    <section id="news" class="py-16 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">News Feed</h2>
                <div class="flex gap-2">
                    <button onclick="filterNews('all')" class="filter-btn px-4 py-2 rounded-lg bg-blue-600 text-white">All</button>
                    <button onclick="filterNews('voting')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Voting</button>
                    <button onclick="filterNews('verified')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Verified</button>
                </div>
            </div>
            
            <div id="newsFeed" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- News items will be inserted here -->
            </div>
        </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="leaderboard" class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Top Contributors</h2>
            
            <div class="max-w-4xl mx-auto">
                <div id="leaderboardList" class="space-y-4">
                    <!-- Leaderboard items will be inserted here -->
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="py-16 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-12 text-center">How It Works</h2>
            
            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-xl shadow-sm card-hover">
                    <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center text-white text-3xl mb-6">
                        üì∞
                    </div>
                    <h3 class="text-2xl font-bold mb-4">1. Submit News</h3>
                    <p class="text-gray-600 leading-relaxed">
                        Submit news articles for community verification. Pay 10 TRUTH tokens to ensure quality submissions.
                    </p>
                </div>
                
                <div class="bg-white p-8 rounded-xl shadow-sm card-hover">
                    <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center text-white text-3xl mb-6">
                        üó≥Ô∏è
                    </div>
                    <h3 class="text-2xl font-bold mb-4">2. Vote & Stake</h3>
                    <p class="text-gray-600 leading-relaxed">
                        Vote TRUE or FALSE on submitted news. Stake TRUTH tokens on your vote. Winners earn rewards!
                    </p>
                </div>
                
                <div class="bg-white p-8 rounded-xl shadow-sm card-hover">
                    <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center text-white text-3xl mb-6">
                        üèÜ
                    </div>
                    <h3 class="text-2xl font-bold mb-4">3. Earn Reputation</h3>
                    <p class="text-gray-600 leading-relaxed">
                        Build your reputation through accurate voting. Climb tiers from Bronze to Platinum!
                    </p>
                </div>
            </div>

            <div class="mt-12 bg-white p-8 rounded-xl shadow-sm">
                <h3 class="text-2xl font-bold mb-6 text-center">Smart Contract Features</h3>
                <div class="grid md:grid-cols-2 gap-6 text-gray-600">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">‚úì On-Chain Voting</h4>
                        <p class="text-sm">All votes are recorded permanently on the Cardano blockchain</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">‚úì Automated Rewards</h4>
                        <p class="text-sm">Smart contracts automatically distribute rewards to accurate voters</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">‚úì Token Staking</h4>
                        <p class="text-sm">Stake TRUTH tokens to increase your voting power and rewards</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">‚úì Reputation System</h4>
                        <p class="text-sm">Build immutable reputation through consistent accuracy</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Wallet Connection Modal -->
    <div id="walletModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">Connect Your Wallet</h3>
            
            <div class="space-y-3">
                <button onclick="connectWithWallet('nami')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 transition flex items-center gap-4">
                    <div class="w-12 h-12 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold">N</div>
                    <div class="text-left">
                        <div class="font-semibold">Nami</div>
                        <div class="text-sm text-gray-500">Connect with Nami Wallet</div>
                    </div>
                </button>
                
                <button onclick="connectWithWallet('eternl')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 transition flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">E</div>
                    <div class="text-left">
                        <div class="font-semibold">Eternl</div>
                        <div class="text-sm text-gray-500">Connect with Eternl Wallet</div>
                    </div>
                </button>
                
                <button onclick="connectWithWallet('flint')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 transition flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center text-white font-bold">F</div>
                    <div class="text-left">
                        <div class="font-semibold">Flint</div>
                        <div class="text-sm text-gray-500">Connect with Flint Wallet</div>
                    </div>
                </button>

                <button onclick="connectWithWallet('lace')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 transition flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">L</div>
                    <div class="text-left">
                        <div class="font-semibold">Lace</div>
                        <div class="text-sm text-gray-500">Connect with Lace Wallet</div>
                    </div>
                </button>
            </div>
            
            <button onclick="closeWalletModal()" class="w-full mt-6 py-3 text-gray-600 hover:text-gray-900 font-medium">
                Cancel
            </button>
        </div>
    </div>

    <!-- Submit News Modal -->
    <div id="submitModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">Submit News for Verification</h3>
            
            <form id="submitNewsForm" onsubmit="handleNewsSubmit(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">News Title *</label>
                        <input type="text" id="newsTitle" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="Enter news headline">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Source URL *</label>
                        <input type="url" id="newsUrl" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="https://example.com/article">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description *</label>
                        <textarea id="newsDescription" required rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="Brief description of the news..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Category *</label>
                        <select id="newsCategory" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">Select category</option>
                            <option value="politics">Politics</option>
                            <option value="technology">Technology</option>
                            <option value="health">Health</option>
                            <option value="science">Science</option>
                            <option value="business">Business</option>
                            <option value="entertainment">Entertainment</option>
                        </select>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">üí∞</div>
                            <div>
                                <div class="font-semibold">Submission Fee</div>
                                <div class="text-sm text-gray-600">10 TRUTH tokens + transaction fee (~0.5 ADA)</div>
                            </div>
                        </div>
                    </div>

                    <div id="truthBalance" class="bg-gray-50 p-4 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold">Your TRUTH Balance:</span>
                            <span class="text-lg font-bold text-blue-600" id="userTruthBalance">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" id="submitNewsBtn" class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition flex items-center justify-center gap-2">
                        <span>Submit News</span>
                    </button>
                    <button type="button" onclick="closeSubmitModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vote Modal -->
    <div id="voteModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">Cast Your Vote</h3>
            
            <div id="voteNewsContent" class="mb-6">
                <!-- Content will be inserted here -->
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">Stake Amount (TRUTH)</label>
                <input type="number" id="stakeAmount" min="1" value="10" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-2">
                    Higher stakes earn greater rewards if your vote is correct
                </p>
            </div>

            <div id="voteBalance" class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold">Your TRUTH Balance:</span>
                    <span class="text-lg font-bold text-blue-600" id="voteTruthBalance">0</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="submitVote(true)" id="voteTrueBtn" class="vote-true text-white py-4 rounded-lg font-bold text-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                    <span>‚úì TRUE</span>
                </button>
                <button onclick="submitVote(false)" id="voteFalseBtn" class="vote-false text-white py-4 rounded-lg font-bold text-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                    <span>‚úó FALSE</span>
                </button>
            </div>
            
            <button onclick="closeVoteModal()" class="w-full mt-4 py-3 text-gray-600 hover:text-gray-900 font-medium">
                Cancel
            </button>
        </div>
    </div>

    <script type="module">
        // Import Lucid
        const { Lucid, Blockfrost, Data, toHex, fromHex, utf8ToHex } = await import('https://unpkg.com/lucid-cardano@0.10.7/web/mod.js');

        // Cardano Configuration
        const BLOCKFROST_API_KEY = "mainnetKZr27HF2BJa890FEbzTx85DQ7st3Eq0h";
        const NETWORK = "Mainnet";
        
        // TRUTH Token Configuration
        const TRUTH_POLICY_ID = "f7d9753d6f766edc8be954ceaaee06c48a748ca2368224b5b9d77135";
        const TRUTH_TOKEN_NAME = "54525554484441"; // "TRUTHDA" in hex
        const SUBMISSION_FEE = 10_000000; // 10 TRUTH (6 decimals)
        const MIN_STAKE = 1_000000; // 1 TRUTH

        // Contract addresses
        // OPTION 1 (Recommended for MVP): Use a treasury wallet address
        // Create a dedicated Cardano wallet and paste the address here
        const VALIDATOR_ADDRESS = "addr1q8zns9rdm4xnq3ehlpf4ee0cksjv2mlmqv3de0278atxdet7glzxtk7nlqjx7kz7atl608vfxw7ahcznluv023kp0cgsw68nw4"; // Your treasury/validator address
        
        // OPTION 2 (Advanced): Deploy the Plutus smart contract and use its address
        // Follow the deployment guide to compile and deploy the validator contract
        
        // Global state
        let lucid = null;
        let connectedWallet = null;
        let walletAPI = null;
        let currentFilter = 'all';
        let currentVoteNewsId = null;
        let truthBalance = 0;

        // Sample News Data
        const newsData = [
            {
                id: 1,
                title: "Major Breakthrough in Renewable Energy Storage",
                description: "Scientists develop new battery technology with 10x capacity",
                url: "https://example.com/news1",
                category: "technology",
                status: "voting",
                truthVotes: 124,
                falseVotes: 23,
                stakedTokens: 1450,
                deadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),
                submitter: "addr1...",
                txHash: ""
            },
            {
                id: 2,
                title: "New Climate Agreement Signed by 50 Nations",
                description: "Historic pact commits to carbon neutrality by 2040",
                url: "https://example.com/news2",
                category: "politics",
                status: "voting",
                truthVotes: 89,
                falseVotes: 45,
                stakedTokens: 980,
                deadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),
                submitter: "addr2...",
                txHash: ""
            },
            {
                id: 3,
                title: "AI Model Achieves Human-Level Performance",
                description: "Latest language model passes comprehensive reasoning tests",
                url: "https://example.com/news3",
                category: "technology",
                status: "verified",
                truthVotes: 234,
                falseVotes: 12,
                stakedTokens: 2890,
                deadline: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                submitter: "addr3...",
                txHash: ""
            },
            {
                id: 4,
                title: "Global Health Initiative Reduces Disease by 40%",
                description: "WHO reports significant progress in disease prevention",
                url: "https://example.com/news4",
                category: "health",
                status: "voting",
                truthVotes: 156,
                falseVotes: 67,
                stakedTokens: 1670,
                deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                submitter: "addr4...",
                txHash: ""
            },
            {
                id: 5,
                title: "Quantum Computer Solves Complex Problem",
                description: "Breakthrough demonstration of quantum advantage in real-world application",
                url: "https://example.com/news5",
                category: "science",
                status: "verified",
                truthVotes: 298,
                falseVotes: 34,
                stakedTokens: 3240,
                deadline: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                submitter: "addr5...",
                txHash: ""
            },
            {
                id: 6,
                title: "Space Agency Announces Mars Mission Timeline",
                description: "Manned mission to Mars planned for 2030",
                url: "https://example.com/news6",
                category: "science",
                status: "voting",
                truthVotes: 178,
                falseVotes: 92,
                stakedTokens: 2100,
                deadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000),
                submitter: "addr6...",
                txHash: ""
            }
        ];

        // Leaderboard Data
        const leaderboardData = [
            { rank: 1, name: "TruthSeeker_42", votes: 847, accuracy: 94, reputation: 12450, tier: 'platinum' },
            { rank: 2, name: "FactChecker", votes: 723, accuracy: 91, reputation: 10230, tier: 'gold' },
            { rank: 3, name: "NewsValidator", votes: 654, accuracy: 88, reputation: 8900, tier: 'gold' },
            { rank: 4, name: "VerifyBot", votes: 589, accuracy: 86, reputation: 7650, tier: 'silver' },
            { rank: 5, name: "HonestVoter", votes: 512, accuracy: 83, reputation: 6780, tier: 'silver' },
            { rank: 6, name: "DataDiver", votes: 467, accuracy: 81, reputation: 5890, tier: 'bronze' },
            { rank: 7, name: "SourceScout", votes: 423, accuracy: 79, reputation: 5120, tier: 'bronze' },
            { rank: 8, name: "InfoInvestigator", votes: 389, accuracy: 77, reputation: 4560, tier: 'bronze' }
        ];

        // Initialize Lucid for Cardano Mainnet
        async function initLucid() {
            try {
                lucid = await Lucid.new(
                    new Blockfrost(
                        `https://cardano-mainnet.blockfrost.io/api/v0`,
                        BLOCKFROST_API_KEY
                    ),
                    NETWORK
                );
                
                console.log("Lucid initialized on Cardano Mainnet");
                return true;
            } catch (error) {
                console.error("Failed to initialize Lucid:", error);
                showNotification("Failed to initialize Cardano connection", "error");
                return false;
            }
        }

        // Get TRUTH token balance
        async function getTruthBalance(address) {
            try {
                if (!TRUTH_POLICY_ID) {
                    return 0;
                }

                const utxos = await lucid.utxosAt(address);
                let balance = 0n;
                
                for (const utxo of utxos) {
                    const assetName = TRUTH_POLICY_ID + TRUTH_TOKEN_NAME;
                    if (utxo.assets[assetName]) {
                        balance += utxo.assets[assetName];
                    }
                }
                
                // Convert from smallest unit (6 decimals)
                return Number(balance) / 1_000000;
            } catch (error) {
                console.error("Error getting TRUTH balance:", error);
                return 0;
            }
        }

        // Update balance display
        async function updateBalanceDisplay() {
            if (!connectedWallet) return;
            
            truthBalance = await getTruthBalance(connectedWallet.address);
            
            const balanceElements = document.querySelectorAll('#userTruthBalance, #voteTruthBalance');
            balanceElements.forEach(el => {
                el.textContent = truthBalance.toFixed(2) + ' TRUTH';
            });
            
            document.getElementById('truthBalance').classList.remove('hidden');
        }

        // Connect to Cardano Wallet
        window.connectWallet = async function() {
            document.getElementById('walletModal').classList.add('active');
        }

        window.connectWithWallet = async function(walletName) {
            try {
                const walletKey = walletName.toLowerCase();
                
                if (!window.cardano || !window.cardano[walletKey]) {
                    showNotification(`${walletName} wallet not found. Please install the extension.`, "error");
                    return;
                }

                if (!lucid) {
                    const initialized = await initLucid();
                    if (!initialized) return;
                }

                showNotification(`Connecting to ${walletName}...`, "info");
                walletAPI = await window.cardano[walletKey].enable();
                
                lucid.selectWallet(walletAPI);
                
                const address = await lucid.wallet.address();
                connectedWallet = {
                    name: walletName,
                    address: address,
                    balance: 0
                };

                try {
                    const utxos = await lucid.wallet.getUtxos();
                    const totalLovelace = utxos.reduce((sum, utxo) => sum + utxo.assets.lovelace, 0n);
                    connectedWallet.balance = Number(totalLovelace) / 1_000000;
                } catch (error) {
                    console.error("Failed to get balance:", error);
                }

                await updateBalanceDisplay();
                updateWalletUI();
                closeWalletModal();
                showNotification(`Connected to ${walletName} on Mainnet!`, "success");
                
            } catch (error) {
                console.error("Wallet connection error:", error);
                showNotification("Failed to connect wallet. Please try again.", "error");
            }
        }

        function updateWalletUI() {
            if (connectedWallet) {
                const shortAddress = connectedWallet.address.slice(0, 8) + '...' + connectedWallet.address.slice(-6);
                document.getElementById('walletSection').innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden md:block">
                            <div class="text-sm font-semibold">${shortAddress}</div>
                            <div class="text-xs text-gray-500">${connectedWallet.balance.toFixed(2)} ADA | ${truthBalance.toFixed(2)} TRUTH</div>
                        </div>
                        <button onclick="disconnectWallet()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition">
                            Disconnect
                        </button>
                    </div>
                `;
            }
        }

        window.disconnectWallet = function() {
            connectedWallet = null;
            walletAPI = null;
            truthBalance = 0;
            document.getElementById('walletSection').innerHTML = `
                <button onclick="connectWallet()" class="gradient-bg text-white px-6 py-2 rounded-lg font-medium hover:opacity-90 transition">
                    Connect Wallet
                </button>
            `;
            showNotification("Wallet disconnected", "info");
        }

        window.closeWalletModal = function() {
            document.getElementById('walletModal').classList.remove('active');
        }

        // Build and submit news submission transaction
        async function buildSubmitNewsTx(newsData) {
            try {
                // Create metadata for the news submission
                const metadata = {
                    721: {
                        "SocialTruthDAO": {
                            "NewsSubmission": {
                                title: newsData.title,
                                url: newsData.url,
                                description: newsData.description,
                                category: newsData.category,
                                timestamp: Date.now()
                            }
                        }
                    }
                };

                // Build transaction
                const tx = await lucid
                    .newTx()
                    .attachMetadata(721, metadata)
                    .payToAddress(VALIDATOR_ADDRESS || await lucid.wallet.address(), {
                        lovelace: 2_000000n // 2 ADA minimum
                    })
                    .complete();

                // Sign transaction
                const signedTx = await tx.sign().complete();
                
                // Submit transaction
                const txHash = await signedTx.submit();
                
                return txHash;
            } catch (error) {
                console.error("Transaction build error:", error);
                throw error;
            }
        }

        // Build and submit vote transaction
        async function buildVoteTx(newsId, voteDecision, stakeAmount) {
            try {
                const stakeInLovelace = BigInt(stakeAmount * 1_000000);
                
                // Create metadata for the vote
                const metadata = {
                    721: {
                        "SocialTruthDAO": {
                            "Vote": {
                                newsId: newsId,
                                vote: voteDecision ? "TRUE" : "FALSE",
                                stake: stakeAmount,
                                timestamp: Date.now()
                            }
                        }
                    }
                };

                // Build transaction
                const tx = await lucid
                    .newTx()
                    .attachMetadata(721, metadata)
                    .payToAddress(VALIDATOR_ADDRESS || await lucid.wallet.address(), {
                        lovelace: 2_000000n + stakeInLovelace
                    })
                    .complete();

                // Sign transaction
                const signedTx = await tx.sign().complete();
                
                // Submit transaction
                const txHash = await signedTx.submit();
                
                return txHash;
            } catch (error) {
                console.error("Vote transaction error:", error);
                throw error;
            }
        }

        // News Feed Functions
        function renderNewsFeed() {
            const newsFeed = document.getElementById('newsFeed');
            
            const filteredNews = newsData.filter(news => {
                if (currentFilter === 'all') return true;
                return news.status === currentFilter;
            });
            
            newsFeed.innerHTML = filteredNews.map(news => {
                const totalVotes = news.truthVotes + news.falseVotes;
                const truthPercentage = totalVotes > 0 ? (news.truthVotes / totalVotes * 100).toFixed(1) : 0;
                
                return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden card-hover">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-3">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusBadgeClass(news.status)}">
                                    ${news.status.toUpperCase()}
                                </span>
                                <span class="text-xs text-gray-500">${news.category}</span>
                            </div>
                            
                            <h3 class="text-lg font-bold mb-2 line-clamp-2">${news.title}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${news.description}</p>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-green-600 font-semibold">TRUE ${truthPercentage}%</span>
                                    <span class="text-red-600 font-semibold">FALSE ${(100 - truthPercentage).toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div class="bg-green-500 h-full transition-all" style="width: ${truthPercentage}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                                <span>üí∞ ${news.stakedTokens} TRUTH staked</span>
                                ${news.status === 'voting' ? `<span>‚è±Ô∏è ${formatDeadline(news.deadline)}</span>` : ''}
                            </div>
                            
                            <div class="flex gap-2">
                                ${news.status === 'voting' ? 
                                    `<button onclick="openVoteModal(${news.id})" class="flex-1 gradient-bg text-white py-2 rounded-lg font-medium hover:opacity-90 transition">
                                        Vote Now
                                    </button>` :
                                    `<button class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Voting Closed
                                    </button>`
                                }
                                <a href="${news.url}" target="_blank" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition">
                                    View
                                </a>
                            </div>
                            ${news.txHash ? `
                                <div class="mt-3 pt-3 border-t border-gray-100">
                                    <a href="https://cardanoscan.io/transaction/${news.txHash}" target="_blank" class="text-xs text-blue-600 hover:underline">
                                        View on Cardanoscan ‚Üí
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterNews = function(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-blue-600', 'text-white');
            
            renderNewsFeed();
        }

        window.openSubmitModal = async function() {
            if (!connectedWallet) {
                showNotification('Please connect your wallet first', 'error');
                connectWallet();
                return;
            }
            
            await updateBalanceDisplay();
            document.getElementById('submitModal').classList.add('active');
        }

        window.closeSubmitModal = function() {
            document.getElementById('submitModal').classList.remove('active');
            document.getElementById('submitNewsForm').reset();
        }

        window.handleNewsSubmit = async function(e) {
            e.preventDefault();
            
            if (!connectedWallet) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            if (truthBalance < 10) {
                showNotification('Insufficient TRUTH tokens. You need at least 10 TRUTH to submit news.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitNewsBtn');
            const originalContent = submitBtn.innerHTML;
            
            const title = document.getElementById('newsTitle').value;
            const url = document.getElementById('newsUrl').value;
            const description = document.getElementById('newsDescription').value;
            const category = document.getElementById('newsCategory').value;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner"></div><span>Creating transaction...</span>';
                
                showNotification('Building transaction...', 'info');
                
                const newsSubmissionData = {
                    title,
                    url,
                    description,
                    category
                };
                
                const txHash = await buildSubmitNewsTx(newsSubmissionData);
                
                submitBtn.innerHTML = '<div class="spinner"></div><span>Awaiting confirmation...</span>';
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                
                // Wait for confirmation (simplified - in production, poll the blockchain)
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                showNotification(`News submitted successfully! TX: ${txHash.slice(0, 10)}...`, 'success');
                
                // Add to news feed
                newsData.unshift({
                    id: newsData.length + 1,
                    title,
                    description,
                    url,
                    category,
                    status: "voting",
                    truthVotes: 0,
                    falseVotes: 0,
                    stakedTokens: 10,
                    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    submitter: connectedWallet.address,
                    txHash: txHash
                });
                
                renderNewsFeed();
                await updateBalanceDisplay();
                updateWalletUI();
                closeSubmitModal();
                
            } catch (error) {
                console.error("Submission error:", error);
                showNotification(`Transaction failed: ${error.message || 'Please try again'}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            }
        }

        window.openVoteModal = async function(newsId) {
            if (!connectedWallet) {
                showNotification('Please connect your wallet first', 'error');
                connectWallet();
                return;
            }
            
            await updateBalanceDisplay();
            
            currentVoteNewsId = newsId;
            const news = newsData.find(n => n.id === newsId);
            
            document.getElementById('voteNewsContent').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold text-lg mb-2">${news.title}</h4>
                    <p class="text-gray-600 text-sm mb-3">${news.description}</p>
                    <a href="${news.url}" target="_blank" class="text-blue-600 text-sm hover:underline">
                        View Source ‚Üí
                    </a>
                </div>
            `;
            
            document.getElementById('voteModal').classList.add('active');
        }

        window.closeVoteModal = function() {
            document.getElementById('voteModal').classList.remove('active');
            currentVoteNewsId = null;
        }

        window.submitVote = async function(vote) {
            if (!connectedWallet) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            const stakeAmount = parseInt(document.getElementById('stakeAmount').value);
            
            if (truthBalance < stakeAmount) {
                showNotification('Insufficient TRUTH tokens for this stake amount', 'error');
                return;
            }

            const trueBtn = document.getElementById('voteTrueBtn');
            const falseBtn = document.getElementById('voteFalseBtn');
            const activeBtn = vote ? trueBtn : falseBtn;
            const originalContent = activeBtn.innerHTML;
            
            try {
                trueBtn.disabled = true;
                falseBtn.disabled = true;
                activeBtn.innerHTML = '<div class="spinner"></div><span>Processing...</span>';
                
                showNotification(`Building ${vote ? 'TRUE' : 'FALSE'} vote transaction...`, 'info');
                
                const txHash = await buildVoteTx(currentVoteNewsId, vote, stakeAmount);
                
                showNotification('Vote transaction submitted! Waiting for confirmation...', 'success');
                
                // Wait for confirmation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                showNotification(`Vote confirmed! TX: ${txHash.slice(0, 10)}...`, 'success');
                closeVoteModal();
                
                // Update news data
                const newsIndex = newsData.findIndex(n => n.id === currentVoteNewsId);
                if (vote) {
                    newsData[newsIndex].truthVotes++;
                } else {
                    newsData[newsIndex].falseVotes++;
                }
                newsData[newsIndex].stakedTokens += stakeAmount;
                if (!newsData[newsIndex].txHash) {
                    newsData[newsIndex].txHash = txHash;
                }
                
                renderNewsFeed();
                await updateBalanceDisplay();
                updateWalletUI();
                
            } catch (error) {
                console.error("Vote error:", error);
                showNotification(`Vote failed: ${error.message || 'Please try again'}`, 'error');
            } finally {
                trueBtn.disabled = false;
                falseBtn.disabled = false;
                activeBtn.innerHTML = originalContent;
            }
        }

        // Leaderboard Functions
        function renderLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            leaderboardList.innerHTML = leaderboardData.map(user => `
                <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between card-hover">
                    <div class="flex items-center gap-6">
                        <div class="text-2xl font-bold text-gray-400 w-8 text-center">
                            ${user.rank <= 3 ? ['ü•á', 'ü•à', 'ü•â'][user.rank - 1] : user.rank}
                        </div>
                        <div>
                            <div class="font-bold text-lg">${user.name}</div>
                            <div class="flex items-center gap-4 text-sm text-gray-600 mt-1">
                                <span>${user.votes} votes</span>
                                <span>${user.accuracy}% accuracy</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="font-bold text-xl text-gray-900">${user.reputation.toLocaleString()}</div>
                            <div class="text-xs text-gray-500">reputation</div>
                        </div>
                        <div class="tier-${user.tier} px-4 py-2 rounded-lg text-white font-semibold text-sm">
                            ${user.tier.toUpperCase()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Utility Functions
        function getStatusBadgeClass(status) {
            const classes = {
                'voting': 'bg-blue-100 text-blue-800',
                'verified': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDeadline(deadline) {
            const now = new Date();
            const diff = deadline - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} left`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} left`;
            return 'Ending soon';
        }

        window.scrollToNews = function() {
            document.getElementById('news').scrollIntoView({ behavior: 'smooth' });
        }

        function animateStats() {
            const totalNews = document.getElementById('totalNews');
            const totalVotes = document.getElementById('totalVotes');
            const activeUsers = document.getElementById('activeUsers');
            
            animateValue(totalNews, 0, 156, 2000);
            animateValue(totalVotes, 0, 2847, 2000);
            animateValue(activeUsers, 0, 432, 2000);
        }

        function animateValue(element, start, end, duration) {
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current).toLocaleString();
            }, 16);
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in max-w-md`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', async () => {
            renderNewsFeed();
            renderLeaderboard();
            animateStats();
            
            // Initialize Lucid on load
            await initLucid();
        });
    </script>
</body>
</html>
